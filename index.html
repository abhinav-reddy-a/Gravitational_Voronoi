<html>
  <header>
    <title>Gravitational Voronoi</title>
  </header>
  <style>
  body {
    background: #e8e8e8;
    font-family: "Open Sans", Arial, sans-serif;
    color: #464646;
    padding: 0;
    margin: 0;
  }

  h1 {
    width: 100%;
    color: #464646;
    font-size: 34px;
    letter-spacing: 1px;
    line-height: 80px;
    height: 80px;
    margin: auto;
    text-align: center;
    border-bottom: 1px solid #464646;
  }

  #container {
    display: flex;
    margin-top: 80px;
    justify-content: center;
  }

  #main-info-container {
    font-size: 20px;
    margin-right: 50px;
  }

  #main-info-container h3 {
    color: #464646;
    font-size: 26px;
    margin: 0;
    padding: 0;
    padding-bottom: 10px;
    border-bottom: 1px solid #666666;
    height: 40px;
  }

  .total-stats-header {
    font-weight: bold;
    letter-spacing: 1px;
    border-bottom: 2px solid #464646;
    height: 50px;
    display: grid;
    grid-template-columns: 40px 140px 120px; 
    align-items: center;
    background: #d0d0d0;
  }

  .total-stats-header div {
    margin: 0 10px;
  }

  .total-stats-container {
    font-weight: bold;
    letter-spacing: 1px;
    border-bottom: 1px solid #666666;
    height: 60px;
    display: grid;
    grid-template-columns: 40px 140px 120px;	      
    align-items: center;
  }

  .total-stats-container div {
    margin: 0 10px;
  }

  .player-info-header {
    font-weight: bold;
    letter-spacing: 1px;
    border-bottom: 2px solid #464646;
    height: 50px;
    display: grid;
    grid-template-columns: 40px 140px 100px 100px 120px; 
    align-items: center;
    background: #d0d0d0;
  }

  .player-info-header div {
    margin: 0 10px;
  }

  .player-info-container {
    font-weight: bold;
    letter-spacing: 1px;
    border-bottom: 1px solid #666666;
    height: 60px;
    display: grid;
    grid-template-columns: 40px 140px 100px 100px 120px;	      
    align-items: center;
  }

  .player-info-container div {
    margin: 0 10px;
  }

  .player-color {
    height: 28px;
    width: 28px;
    margin-left: 6px !important;
  }

  #time-taken {
    padding-top: 100px;
  }

  #clock {
    font-size: 54px;
    text-align: center;
    padding-top: 30px;
  }

  #game-over {
    font-size: 50px;
    text-align: center;
    padding-top: 50px;
  }

  #rounds-container {
    display: flex;
    flex-direction: column-reverse;
    gap: 40px;
  }

  .round-section {
    display: flex;
    gap: 30px;
    align-items: flex-start;
  }

  .round-info {
    font-size: 20px;
  }

  .round-title {
    color: #464646;
    font-size: 24px;
    font-weight: bold;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 2px solid #464646;
  }

  .game-canvas {
    border: 1px solid #464646;
    height: 700px;
    width: 700px;
  }

  </style>
  <body>
    <h1>
      Gravitational Voronoi
    </h1>
    <div id="container">
      <div id="main-info-container">
        <h3>Total Stats</h3>
        <div id="total-stats"></div>
        <div id="time-taken">
          <h3>Current Move Time</h3>
          <div id="clock">0.00</div>
        </div>
        <div id="game-over"></div>
      </div>
      <div id="rounds-container"></div>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script type="text/javascript">
      var socket = io("127.0.0.1:10000");

      var roundsContainer = document.getElementById('rounds-container');
      var currentRoundSection = null;
      var canvas = null;
      var ctx = null;
      var canvasWidth = 1000;
      var canvasHeight = 1000;
      var boardSize = canvasWidth;

      var initiated = false;
      var totalScores = [];
      var lastScores = [];
      var roundNumber = 1;
      var playerNames = [];

      var colors = ['red', 'blue', 'green', 'orange', 'yellow', 'purple',
          'silver', 'olive', 'teal'];

      var colorRGB = [[255,0,0], [0,0,255], [0,255,0], [255,165,0],
          [255,255,0], [128,0,128], [192,192,192],
          [128,128,0], [0,128,128]];

      var moves = [];

      var clockInterval;
      var clockStart;

      function createNewRound() {
        // Create round section
        var roundSection = document.createElement('div');
        roundSection.className = 'round-section';

        // Create round info div
        var roundInfo = document.createElement('div');
        roundInfo.className = 'round-info';

        // Add round title
        var roundTitle = document.createElement('div');
        roundTitle.className = 'round-title';
        roundTitle.textContent = 'Round ' + roundNumber;
        roundInfo.appendChild(roundTitle);

        // Add player info table
        var playerInfoDiv = document.createElement('div');
        playerInfoDiv.className = 'round-player-info';
        
        // Add header
        var headerRow = document.createElement('div');
        headerRow.classList.add('player-info-header');
        headerRow.innerHTML = `
          <div></div>
          <div>Name</div>
          <div>Time</div>
          <div>Round %</div>
          <div>Weight Pool</div>
        `;
        playerInfoDiv.appendChild(headerRow);

        // Add player rows
        for (var i = 0; i < playerNames.length; i++) {
          playerInfoDiv.appendChild(getInfoComponent(playerNames[i], i));
        }

        roundInfo.appendChild(playerInfoDiv);

        // Create canvas
        var newCanvas = document.createElement('canvas');
        newCanvas.className = 'game-canvas';
        newCanvas.width = 1000;
        newCanvas.height = 1000;

        // Add to round section
        roundSection.appendChild(roundInfo);
        roundSection.appendChild(newCanvas);

        // Add to container
        roundsContainer.appendChild(roundSection);

        // Update references
        currentRoundSection = roundSection;
        canvas = newCanvas;
        ctx = canvas.getContext('2d');

        roundNumber++;
        return newCanvas;
      }

      function drawStones(boardData) {
        var board = boardData.split(" ");
        var j = parseInt(board[board.length - 1]);
        var i = parseInt(board[board.length - 2]);
        var currentTurn = parseInt(board[board.length - 3]);

        moves[currentTurn - 1].push([j, i]);

        for(var b = 0 ; b < moves.length ; b++)
        {
          for(var a = 0 ; a < moves[b].length ; a++)
          {
            var centerX = moves[b][a][0];
            var centerY = moves[b][a][1];
            var radius = 10;

            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI, false);

            var color = colors[b];

            ctx.fillStyle = color;
            ctx.fill();
            ctx.lineWidth = 3;
            ctx.strokeStyle = '#003300';
            ctx.stroke();
          }
        }
      }

      function decompressBitmap(boardData) {
        const numericBoard = boardData.split(" ").map(Number);
        const decompressedBoard = [];
        let i = 0;
        for (let j = 0;; j += 3) {
          for (let k = numericBoard[j]; k <= numericBoard[j + 1]; k++) {
            decompressedBoard.push(numericBoard[j + 2]);
          }
          if (numericBoard[j + 1] === 999) {
            i += 1
            if (i === 1000) {
              break;
            }
          }
        }
        return decompressedBoard;
      }

      function drawBoard(boardData) {
        var board = boardData.split(" ");
        var j = parseInt(board[board.length - 1]);
        var i = parseInt(board[board.length - 2]);
        var numberOfPlayers = parseInt([board[board.length - 4]]);
        board = decompressBitmap(boardData);

        if (moves.length == 0)
        {
          for(var i = 0 ; i < numberOfPlayers ; i++)
          {
            moves.push([]);
          }
        }

        var imageData = ctx.getImageData(0, 0, canvasWidth, canvasHeight);
        var data = imageData.data;


        for (var y = 0; y < 1000; y++)
        {
          for (var x = 0; x < 1000; x++)
          {
            var index = (y * 1000 + x) * 4;

            var player = parseInt(board[index/4]);

            if(player > 0)
            {
              var gridColor = colorRGB[player - 1];

              data[index]   = gridColor[0];
              data[++index] = gridColor[1];
              data[++index] = gridColor[2];
              data[++index] = 125;
            }
          }
        }

        ctx.putImageData(imageData, 0, 0);
      }

      function getInfoComponent(name, index) {
        var infoComponent = document.createElement('div');
        var nameComponent = document.createElement('div');
        var colorComponent = document.createElement('div');
        var scoreComponent = document.createElement('div');
        var timeComponent = document.createElement('div');
        var weightPoolComponent = document.createElement('div');

        infoComponent.classList.add('player-info-container')
        infoComponent.setAttribute('player-id', index.toString());
        nameComponent.classList.add('player-name');
        nameComponent.textContent = name;
        colorComponent.classList.add('player-color');
        colorComponent.style.background = colors[index];
        scoreComponent.classList.add('player-score');
        scoreComponent.textContent = '0';
        timeComponent.classList.add('player-time');
        timeComponent.textContent = '120s';
        weightPoolComponent.classList.add('player-weight-pool');
        weightPoolComponent.textContent = '0';

        infoComponent.appendChild(colorComponent);
        infoComponent.appendChild(nameComponent);
        infoComponent.appendChild(timeComponent);
        infoComponent.appendChild(scoreComponent);
        infoComponent.appendChild(weightPoolComponent);

        return infoComponent;
      }

      function getTotalStatsComponent(name, index) {
        var infoComponent = document.createElement('div');
        var nameComponent = document.createElement('div');
        var colorComponent = document.createElement('div');
        var totalScoreComponent = document.createElement('div');

        infoComponent.classList.add('total-stats-container')
        infoComponent.setAttribute('player-id', index.toString());
        nameComponent.classList.add('player-name');
        nameComponent.textContent = name;
        colorComponent.classList.add('player-color');
        colorComponent.style.background = colors[index];
        totalScoreComponent.classList.add('total-player-score');
        totalScoreComponent.textContent = '0%';

        infoComponent.appendChild(colorComponent);
        infoComponent.appendChild(nameComponent);
        infoComponent.appendChild(totalScoreComponent);

        return infoComponent;
      }

      function resetClock(shouldClearInterval = false) {
        if (shouldClearInterval) {
          clearInterval(clockInterval);
        }
        document.querySelector('#clock').textContent = '0.00';
        clockStart = new Date().getTime();
        clockInterval = setInterval(() => {
          let timeTaken = new Date().getTime() - clockStart;
          timeTaken /= 1000;
          document.querySelector('#clock').textContent = timeTaken.toFixed(2);
        }, 100);
      }

      function init(names) {
        var nameArr = names.split('"NAME_SEPARATOR"');
        playerNames = nameArr;
        
        var totalStatsDiv = document.getElementById('total-stats');

        // ADD HEADER ROW for total stats
        var headerRow = document.createElement('div');
        headerRow.classList.add('total-stats-header');
        headerRow.innerHTML = `
          <div></div>
          <div>Name</div>
          <div>Total %</div>
        `;
        totalStatsDiv.appendChild(headerRow);

        for (var i = 0; i < nameArr.length; i++) {
          totalStatsDiv.appendChild(getTotalStatsComponent(nameArr[i], i));
          totalScores.push(0);
        }
  
        // Create first round
        createNewRound();
  
        resetClock(false);
      }


      function updatePlayers(boardData) {
        var board = boardData.split(" ");
        var numberOfPlayers = parseInt([board[board.length - 4]]);
        var weightPools = board.slice(board.length - 4 - numberOfPlayers, board.length - 4);
        var scores = board.slice(board.length - 4 - 2 * numberOfPlayers, board.length - 4 - numberOfPlayers);
        var times = board.slice(board.length - 4 - 3 * numberOfPlayers, board.length - 4 - 2 * numberOfPlayers);
        
        // Update total stats
        var totalStatsInfo = document.querySelectorAll('#total-stats .total-stats-container');
        
        var totalRoundScore = 0;
        scores.forEach(function(singleScore) {
          totalRoundScore += parseInt(singleScore, 10);
        });
        var tempTotalScores = totalScores.map(function(singleScore, i) {
          return singleScore + parseInt(scores[i], 10);
        });
        var totalScore = 0;
        tempTotalScores.forEach(function(singleScore) {
          totalScore += singleScore;
        });
        
        // Update total stats
        totalStatsInfo.forEach(function(info) {
          var i = parseInt(info.getAttribute('player-id'));
          var percentageScore = (100 * tempTotalScores[i] / totalScore).toFixed(1);
          info.querySelector('.total-player-score').textContent = `${percentageScore}%`;
        });
        
        // Update round info (no total %) - only if currentRoundSection exists
        if (currentRoundSection) {
          var roundPlayerInfo = currentRoundSection.querySelectorAll('.player-info-container');
          roundPlayerInfo.forEach(function(info) {
            var i = parseInt(info.getAttribute('player-id'));
            var percentageRoundScore = (100 * parseInt(scores[i], 10) / totalRoundScore).toFixed(1);
            info.querySelector('.player-score').textContent = `${percentageRoundScore}%`;
            info.querySelector('.player-time').textContent = times[i] + 's';
            info.querySelector('.player-weight-pool').textContent = weightPools[i];
          });
        }
        
        lastScores = scores.map(function(singleScore) {return parseInt(singleScore, 10)});
      }

      function softReset() {
        // Create new round
        createNewRound();
        moves = [];
        document.querySelector('#game-over').textContent = "";
      }

      function resetBoard() {
        initiated = false;
        roundsContainer.innerHTML = "";
        currentRoundSection = null;
        canvas = null;
        ctx = null;
        moves = [];
        totalScores = [];
        lastScores = [];
        roundNumber = 1;
        playerNames = [];
        document.getElementById('total-stats').innerHTML = "";
        document.querySelector('#game-over').textContent = "";
      }

      function endGame() {
        clearInterval(clockInterval);
        document.querySelector('#clock').textContent = '0.00';
        document.querySelector('#game-over').textContent = 'Game Over';
        totalScores = totalScores.map(function(singleScore, i) {
          return singleScore + lastScores[i];
        });
        var oReq = new XMLHttpRequest();
        oReq.open('POST', '/artwork');
        oReq.setRequestHeader('Content-Type', 'text/plain');
        oReq.send(canvas.toDataURL());
      }

      var buffer = '';
      var messages = [];
      socket.on('to_client', function(data)
        {
          buffer += data;
          if (buffer[buffer.length - 1] == '\n') {
            messages = messages.concat(buffer.split('\n')).filter(x => x);
            messages.forEach(curMsg => {
              if (curMsg === 'reset') {
                resetBoard();
              } else if (!initiated) {
                init(curMsg);
                initiated = true;
              } else if (curMsg === 'soft-reset') {
                softReset();
              } else if (curMsg === 'game over') {
                endGame();
              } else {
                // Drawing data
                drawBoard(curMsg);
                drawStones(curMsg);
                updatePlayers(curMsg);
                resetClock(true);
              }
            });
            // Reset buffer for next message
            buffer = '';
            messages = [];
          }
        });
    </script>
  </body>
</html>